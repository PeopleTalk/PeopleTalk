import React, { useMemo, useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy, where, doc, deleteDoc } from 'firebase/firestore';

const countries = [
  { name: 'All', emoji: 'üåç' },
  { name: 'USA', emoji: 'üá∫üá∏' },
  { name: 'India', emoji: 'üáÆüá≥' },
  { name: 'Canada', emoji: 'üá®üá¶' },
  { name: 'UK', emoji: 'üá¨üáß' },
  { name: 'Germany', emoji: 'üá©üá™' },
  { name: 'Australia', emoji: 'üá¶üá∫' },
  { name: 'Brazil', emoji: 'üáßüá∑' },
  { name: 'Japan', emoji: 'üáØüáµ' },
];

const trendingTopics = [
  '#PeopleTalkLaunch',
  '#CommunityVoices',
  '#DesignInspiration',
  '#TechStories',
  '#WorldUpdates',
];

const suggestedFriends = [
  { name: 'Maya Johnson', interest: 'Design ‚Ä¢ USA' },
  { name: 'Arjun Patel', interest: 'Startups ‚Ä¢ India' },
  { name: 'Liam Carter', interest: 'Travel ‚Ä¢ UK' },
];

const formatPostTime = (value) => {
  if (!value?.toDate) return 'Just now';

  const date = value.toDate();
  const diffMs = Date.now() - date.getTime();
  const minute = 60 * 1000;
  const hour = 60 * minute;
  const day = 24 * hour;

  if (diffMs < minute) return 'Just now';
  if (diffMs < hour) return `${Math.floor(diffMs / minute)}m ago`;
  if (diffMs < day) return `${Math.floor(diffMs / hour)}h ago`;

  return date.toLocaleDateString(undefined, {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });
};

const App = () => {
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  const [db, setDb] = useState(null);
  const [userId, setUserId] = useState(null);
  const [userName, setUserName] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [loginName, setLoginName] = useState('');

  const [posts, setPosts] = useState([]);
  const [newPostText, setNewPostText] = useState('');
  const [selectedCountry, setSelectedCountry] = useState('All');
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const setup = async () => {
      if (!Object.keys(firebaseConfig).length) {
        setIsAuthReady(true);
        setIsLoading(false);
        return;
      }

      try {
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const firebaseAuth = getAuth(app);

        setDb(firestore);

        onAuthStateChanged(firebaseAuth, async (user) => {
          if (user) {
            setUserId(user.uid);
            setIsAuthReady(true);
          } else if (initialAuthToken) {
            await signInWithCustomToken(firebaseAuth, initialAuthToken);
          } else {
            await signInAnonymously(firebaseAuth);
          }
        });
      } catch (error) {
        console.error('Firebase initialization error:', error);
        setIsAuthReady(true);
        setIsLoading(false);
      }
    };

    setup();
  }, [firebaseConfig, initialAuthToken]);

  useEffect(() => {
    const storedName = localStorage.getItem('userName');
    if (storedName) {
      setUserName(storedName);
    }
  }, []);

  useEffect(() => {
    if (!db || !userName) {
      setPosts([]);
      setIsLoading(false);
      return;
    }

    setIsLoading(true);

    const postsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
    const baseQuery = selectedCountry === 'All'
      ? query(postsCollectionRef, orderBy('createdAt', 'desc'))
      : query(postsCollectionRef, where('country', '==', selectedCountry), orderBy('createdAt', 'desc'));

    const unsubscribe = onSnapshot(
      baseQuery,
      (snapshot) => {
        const fetched = snapshot.docs.map((snapshotDoc) => ({
          id: snapshotDoc.id,
          ...snapshotDoc.data(),
        }));

        setPosts(fetched);
        setIsLoading(false);
      },
      (error) => {
        console.error('Error fetching posts:', error);
        setIsLoading(false);
      },
    );

    return () => unsubscribe();
  }, [db, userName, selectedCountry, appId]);

  const countryPostCount = useMemo(() => {
    const counts = {};
    posts.forEach((post) => {
      counts[post.country] = (counts[post.country] || 0) + 1;
    });
    return counts;
  }, [posts]);

  const handlePostSubmit = async (event) => {
    event.preventDefault();

    if (!newPostText.trim() || !userId || !userName || selectedCountry === 'All' || !db) {
      return;
    }

    try {
      const postsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
      await addDoc(postsCollectionRef, {
        text: newPostText.trim(),
        country: selectedCountry,
        authorId: userId,
        authorName: userName,
        createdAt: serverTimestamp(),
      });

      setNewPostText('');
    } catch (error) {
      console.error('Error adding document:', error);
    }
  };

  const handleDeletePost = async (postId) => {
    if (!userId || !db) return;

    try {
      const postDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
      await deleteDoc(postDocRef);
    } catch (error) {
      console.error('Error deleting post:', error);
    }
  };

  const handleAnonymousLogin = (event) => {
    event.preventDefault();
    if (!loginName.trim()) return;

    localStorage.setItem('userName', loginName.trim());
    setUserName(loginName.trim());
  };

  const handleChangeUser = () => {
    localStorage.removeItem('userName');
    setUserName(null);
    setLoginName('');
  };

  if (!isAuthReady) {
    return (
      <div className="min-h-screen bg-slate-950 text-white flex items-center justify-center">
        <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-8 text-center shadow-2xl backdrop-blur-xl">
          <div className="mx-auto h-10 w-10 rounded-full border-4 border-blue-500 border-t-transparent animate-spin" />
          <p className="mt-4 text-sm text-slate-300">Connecting you to People Talk...</p>
        </div>
      </div>
    );
  }

  if (!userName) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-blue-950 text-white flex items-center justify-center p-4">
        <div className="w-full max-w-md rounded-3xl border border-slate-700/70 bg-slate-900/80 p-8 shadow-2xl backdrop-blur-xl">
          <div className="text-center">
            <p className="inline-flex items-center rounded-full border border-blue-400/30 bg-blue-500/20 px-3 py-1 text-xs font-semibold tracking-wide text-blue-200">
              Smooth social experience
            </p>
            <h1 className="mt-4 text-4xl font-extrabold tracking-tight">People Talk</h1>
            <p className="mt-2 text-sm text-slate-300">Share ideas with your community, instantly.</p>
          </div>

          <form onSubmit={handleAnonymousLogin} className="mt-8 space-y-4">
            <input
              type="text"
              value={loginName}
              onChange={(event) => setLoginName(event.target.value)}
              placeholder="Choose a display name"
              className="w-full rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-3 text-white placeholder:text-slate-500 outline-none transition focus:border-blue-400 focus:ring-2 focus:ring-blue-500/40"
              required
            />
            <button
              type="submit"
              className="w-full rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 py-3 font-bold shadow-lg transition hover:scale-[1.01] hover:from-blue-500 hover:to-indigo-500"
            >
              Enter People Talk
            </button>
          </form>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-950 text-white">
      <div className="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <header className="mb-6 rounded-2xl border border-slate-800 bg-slate-900/60 px-5 py-4 shadow-xl backdrop-blur">
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div>
              <h1 className="text-3xl font-black tracking-tight">People Talk</h1>
              <p className="text-sm text-slate-300">Welcome back, {userName}. Your world is talking.</p>
            </div>
            <button
              onClick={handleChangeUser}
              className="rounded-xl border border-red-400/30 bg-red-500/20 px-4 py-2 text-sm font-semibold text-red-200 transition hover:bg-red-500/30"
            >
              Switch Profile
            </button>
          </div>
        </header>

        <div className="grid gap-6 lg:grid-cols-[260px_minmax(0,1fr)_280px]">
          <aside className="space-y-4">
            <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
              <h2 className="text-sm font-semibold uppercase tracking-wide text-slate-300">Communities</h2>
              <div className="mt-3 space-y-2">
                {countries.map((country) => (
                  <button
                    key={country.name}
                    onClick={() => setSelectedCountry(country.name)}
                    className={`w-full rounded-xl px-3 py-2 text-left text-sm transition ${selectedCountry === country.name ? 'bg-blue-600/80 text-white shadow-md' : 'bg-slate-800/80 text-slate-200 hover:bg-slate-700'}`}
                  >
                    <span className="mr-2">{country.emoji}</span>
                    {country.name}
                    {country.name !== 'All' && countryPostCount[country.name] ? (
                      <span className="float-right rounded-full bg-black/30 px-2 py-0.5 text-xs">{countryPostCount[country.name]}</span>
                    ) : null}
                  </button>
                ))}
              </div>
            </div>

            <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
              <h2 className="text-sm font-semibold uppercase tracking-wide text-slate-300">Trending Now</h2>
              <ul className="mt-3 space-y-2 text-sm text-slate-200">
                {trendingTopics.map((topic) => (
                  <li key={topic} className="rounded-lg bg-slate-800/70 px-3 py-2">{topic}</li>
                ))}
              </ul>
            </div>
          </aside>

          <main className="space-y-4">
            <section className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-lg">
              <form onSubmit={handlePostSubmit} className="space-y-3">
                <textarea
                  value={newPostText}
                  onChange={(event) => setNewPostText(event.target.value)}
                  rows="3"
                  placeholder={selectedCountry === 'All' ? 'Select a community to post your update...' : `Share an update with ${selectedCountry}...`}
                  className="w-full resize-none rounded-xl border border-slate-700 bg-slate-950/70 p-3 text-white placeholder:text-slate-500 outline-none transition focus:border-blue-400 focus:ring-2 focus:ring-blue-500/40"
                  required
                />
                <button
                  type="submit"
                  disabled={!newPostText.trim() || selectedCountry === 'All' || !db}
                  className="w-full rounded-xl bg-blue-600 py-2.5 font-semibold transition enabled:hover:bg-blue-500 disabled:cursor-not-allowed disabled:opacity-40"
                >
                  Post to {selectedCountry}
                </button>
              </form>
            </section>

            {isLoading ? (
              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-8 text-center text-slate-300">
                <div className="mx-auto h-8 w-8 rounded-full border-4 border-blue-500 border-t-transparent animate-spin" />
                <p className="mt-3">Loading posts...</p>
              </div>
            ) : posts.length === 0 ? (
              <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-8 text-center text-slate-300">
                <p className="text-lg font-semibold">No posts yet.</p>
                <p className="mt-1 text-sm text-slate-400">Be the first one to start the conversation in this community.</p>
              </div>
            ) : (
              <section className="space-y-4">
                {posts.map((post) => {
                  const postCountry = countries.find((country) => country.name === post.country);
                  return (
                    <article key={post.id} className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 shadow-lg">
                      <div className="mb-3 flex items-center justify-between">
                        <div>
                          <p className="text-sm font-semibold text-slate-100">{post.authorName || 'Anonymous User'}</p>
                          <p className="text-xs text-slate-400">{formatPostTime(post.createdAt)}</p>
                        </div>
                        <div className="rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-200">
                          {postCountry?.emoji} {post.country || 'Global'}
                        </div>
                      </div>

                      <p className="whitespace-pre-wrap text-[15px] leading-relaxed text-slate-100">{post.text}</p>

                      <div className="mt-4 flex items-center justify-between border-t border-slate-800 pt-3 text-sm text-slate-400">
                        <div className="space-x-4">
                          <button className="transition hover:text-blue-300">üëç Like</button>
                          <button className="transition hover:text-blue-300">üí¨ Comment</button>
                          <button className="transition hover:text-blue-300">‚Üó Share</button>
                        </div>
                        {post.authorId === userId ? (
                          <button
                            onClick={() => handleDeletePost(post.id)}
                            className="text-red-300 transition hover:text-red-200"
                          >
                            Delete
                          </button>
                        ) : null}
                      </div>
                    </article>
                  );
                })}
              </section>
            )}
          </main>

          <aside className="space-y-4">
            <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
              <h2 className="text-sm font-semibold uppercase tracking-wide text-slate-300">People You May Know</h2>
              <ul className="mt-3 space-y-3">
                {suggestedFriends.map((person) => (
                  <li key={person.name} className="rounded-xl bg-slate-800/70 p-3">
                    <p className="font-semibold text-slate-100">{person.name}</p>
                    <p className="text-xs text-slate-400">{person.interest}</p>
                    <button className="mt-2 rounded-lg bg-blue-600 px-3 py-1 text-xs font-semibold transition hover:bg-blue-500">
                      Follow
                    </button>
                  </li>
                ))}
              </ul>
            </div>

            <div className="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 text-xs text-slate-400">
              <p className="font-semibold text-slate-300">People Talk</p>
              <p className="mt-1">A smooth social network experience inspired by modern community apps.</p>
            </div>
          </aside>
        </div>
      </div>
    </div>
  );
};

export default App;
